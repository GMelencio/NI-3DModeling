<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Sphere drawing simulator to s</title>
</head>
<body>
    <div id="container"></div>

    <script src="http://code.jquery.com/jquery-2.1.1.js"></script>
    <script src="http://threejs.org/build/three.min.js"></script>
    <script src="http://threejs.org/examples/js/controls/OrbitControls.js"></script>
    <script src="http://threejs.org/examples/js/Detector.js"></script>
    <script src="http://threejs.org/examples/js/libs/stats.min.js"></script>
    <script src="http://js.leapmotion.com/leap-0.6.4.js"></script>
    <script src="http://js.leapmotion.com/leap-plugins-0.1.10.js"></script>
    <script src="http://js.leapmotion.com/leap.rigged-hand-0.1.5.js"></script>
    <script src="Scripts/Diagnostics.js"></script>

    <script>
        var renderer, scene, camera, riggedHandPlugin, fadingSpheres
        var sphereTTL = 7;

        function initScene() {
            camera = new THREE.PerspectiveCamera(80, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.z = 200;
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0xcccccc, 0.002);

            var light = new THREE.DirectionalLight(0xffffff);
            light.position.set(1, 1, 1);
            scene.add(light);

            // renderer
            renderer = new THREE.WebGLRenderer({ antialias: false });

            renderer.setSize(window.innerWidth, window.innerHeight);

            container = document.getElementById('container');
            container.appendChild(renderer.domElement);

            fadingSpheres = [];
        }

        function render() {
            requestAnimationFrame(render);
            renderer.render(scene, camera);
            if (fadingSpheres) {
                fadingSpheres.forEach(removeDeadSpheres);
            }
        }

        function FadingSphere(position, size, meshColor) {
            //Draw the sphere at the position of the indexfinger tip position
            var geometry = new THREE.SphereGeometry(3, 8, 8);
            var material = new THREE.MeshLambertMaterial({ color: meshColor});

            var mesh = new THREE.Mesh(geometry, material);

            mesh.material.ambient = mesh.material.color;

            mesh.position.x = position.x;
            mesh.position.y = position.y;
            mesh.position.z = position.z;

            this.sphere = mesh;

            scene.add(this.sphere);
            fadingSpheres.push(this);

            this.ttl = sphereTTL;
            this.updateToRemove = function () {
                this.ttl--;
                return (this.ttl <= 0);
            }
        }

        function removeDeadSpheres(fadingSphere, number, array) {
            if (fadingSphere) {
                if (fadingSphere.updateToRemove()) {
                    scene.remove(fadingSphere.sphere);
                    var index = array.indexOf(fadingSphere);
                    array.splice(index, 1);
                }
            }
        }

        //Within the leap draw loop
        //Leap loop to call drawing functions
        Leap.loop(
          function (frame) {
              //var interactionBox = frame.interactionBox;
              frame.hands.forEach(
                function (hand) {
                    var handMesh = hand.data('riggedHand.mesh');

                    function createSphereAtFingerTip(fingerIndex, colorHex) {
                        //var position = handMesh.fingers[fingerIndex].tip.getWorldPosition();
                        //var position = hand.fingers[fingerIndex].tipPosition.getWorldPosition()

                        handMesh.scenePosition()
                        var position = getPositionInWorld(hand.fingers[fingerIndex].tipPosition, frame.interactionBox);
                        new FadingSphere(position, 3, colorHex);
                    }

                    createSphereAtFingerTip(0, 0xF57E20) //Thumb
                    createSphereAtFingerTip(1, 0xFFCC00) //Index
                    createSphereAtFingerTip(2, 0xCCCC51) //Middle
                    createSphereAtFingerTip(3, 0x8FB258) //Ring
                    createSphereAtFingerTip(4, 0x336699) //pinky
                }
           )
          }
        )
        .use('riggedHand')
        .use('handEntry')

        riggedHandPlugin = Leap.loopController.plugins.riggedHand;

        initScene();
        render();

        function getPositionInWorld(leapPoint, iBox) {
            var normalized = iBox.normalizePoint(leapPoint, true);
            var halfWidth = window.innerWidth / 2
            var xCoord = (halfWidth * normalized[0]) - halfWidth;
            var yCoord = 0//window.innerHeight * (1 - normalized[1]);
            var zCoord = 0;//window.innerWidth * normalized[2];
            //var z = normalized[2];
            //// if changing from right-hand to left-hand rule, use:
            ////var z = normalized[2] * -1.0;
            ////recenter origin
            //var x = normalized[0] + 0.5;
            //z += 0.5;
            ////scale
            //x *= 100;
            //var y = normalized[1] * 100;
            //z *= 100;
            return new THREE.Vector3(xCoord, yCoord, zCoord);
            //return Leap.vec3.fromValues(xCoord, yCoord, zCoord);
        }
    </script>
</body>
</html>
